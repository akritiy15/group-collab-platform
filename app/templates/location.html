{% extends "base.html" %}

{% block content %}

<h2>Live Group Locations üìç</h2>

<button onclick="startLiveTracking()" class="btn btn-primary">
    Start Live Location
</button>

<div id="map"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
#map {
    height: 500px;
    width: 100%;
    margin-top: 1.5rem;
}
</style>

<script>

var groupId = {{ group_id }};

var map = L.map('map').setView([20.5937, 78.9629], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
}).addTo(map);

var markers = [];

function startLiveTracking() {

    if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
    }

    navigator.geolocation.getCurrentPosition(function(position) {

        fetch(`/location/share-location/${groupId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                lat: position.coords.latitude,
                lng: position.coords.longitude
            })
        });

    });
}

function loadLocations() {

    fetch(`/location/api/${groupId}`)
    .then(response => response.json())
    .then(data => {

        markers.forEach(m => map.removeLayer(m));
        markers = [];

        if (data.length === 0) {
            return;
        }

        var bounds = [];

        data.forEach(loc => {

            var marker = L.marker([loc.latitude, loc.longitude])
                .addTo(map)
                .bindPopup("User ID: " + loc.user_id);

            markers.push(marker);

            bounds.push([loc.latitude, loc.longitude]);
        });

        map.fitBounds(bounds, { padding: [50, 50] });

    });
}

loadLocations();
setInterval(loadLocations, 5000);
setInterval(startLiveTracking, 10000);

</script>

{% endblock %}